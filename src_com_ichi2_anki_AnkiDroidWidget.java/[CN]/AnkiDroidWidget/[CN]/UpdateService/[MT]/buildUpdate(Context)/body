{
  Log.i(AnkiDroidApp.TAG,"buildUpdate");
  RemoteViews updateViews=new RemoteViews(context.getPackageName(),R.layout.widget);
  Deck currentDeck=AnkiDroidApp.deck();
  if (!AnkiDroidApp.isSdCardMounted()) {
    updateViews.setTextViewText(R.id.anki_droid_title,context.getText(R.string.sdcard_missing_message));
    updateViews.setTextViewText(R.id.anki_droid_name,"");
    updateViews.setTextViewText(R.id.anki_droid_status,"");
    return updateViews;
  }
  if (currentDeck != null) {
    currentDeck.closeDeck();
  }
  ArrayList<DeckInformation> decks=fetchDeckInformation();
  if (currentDeck != null) {
    AnkiDroidApp.setDeck(currentDeck);
    Deck.openDeck(currentDeck.getDeckPath());
  }
  SpannableStringBuilder sb=new SpannableStringBuilder();
  int totalDue=0;
  int nbDecks=decks.size();
  if (nbDecks == 0) {
    updateViews.setTextViewText(R.id.anki_droid_name,"");
    updateViews.setTextViewText(R.id.anki_droid_status,"");
  }
 else {
    DeckInformation deck=decks.get(0);
    updateViews.setTextViewText(R.id.anki_droid_name,deck.mDeckName);
    updateViews.setTextViewText(R.id.anki_droid_status,deck.getDeckStatus());
  }
  int hasDueCount=0;
  for (int i=0; i < nbDecks; i++) {
    DeckInformation deck=decks.get(i);
    if (deck.mDueCards > 0) {
      hasDueCount++;
      totalDue+=deck.mDueCards;
    }
  }
  if (totalDue > 0) {
    updateViews.setTextViewText(R.id.anki_droid_title,context.getString(R.string.widget_cards_in_decks_due,totalDue,hasDueCount));
  }
 else {
    updateViews.setTextViewText(R.id.anki_droid_title,context.getString(R.string.widget_no_cards_due));
  }
  Intent ankiDroidIntent=new Intent(context,StudyOptions.class);
  ankiDroidIntent.setAction(Intent.ACTION_MAIN);
  ankiDroidIntent.addCategory(Intent.CATEGORY_LAUNCHER);
  PendingIntent pendingAnkiDroidIntent=PendingIntent.getActivity(context,0,ankiDroidIntent,0);
  updateViews.setOnClickPendingIntent(R.id.anki_droid_logo,pendingAnkiDroidIntent);
  SharedPreferences preferences=PrefSettings.getSharedPrefs(context);
  int minimumCardsDueForNotification=Integer.parseInt(preferences.getString("minimumCardsDueForNotification","25"));
  if (totalDue >= minimumCardsDueForNotification) {
    String ns=Context.NOTIFICATION_SERVICE;
    NotificationManager mNotificationManager=(NotificationManager)getSystemService(ns);
    int icon=R.drawable.anki;
    CharSequence tickerText=String.format(getString(R.string.widget_minimum_cards_due_notification_ticker_text),totalDue);
    long when=System.currentTimeMillis();
    Notification notification=new Notification(icon,tickerText,when);
    if (preferences.getBoolean("widgetVibrate",false)) {
      notification.defaults|=Notification.DEFAULT_VIBRATE;
    }
    if (preferences.getBoolean("widgetBlink",false)) {
      notification.defaults|=Notification.DEFAULT_LIGHTS;
    }
    Context appContext=getApplicationContext();
    CharSequence contentTitle=getText(R.string.widget_minimum_cards_due_notification_ticker_title);
    String contentText=sb.toString();
    notification.setLatestEventInfo(appContext,contentTitle,contentText,pendingAnkiDroidIntent);
    final int WIDGET_NOTIFY_ID=1;
    mNotificationManager.notify(WIDGET_NOTIFY_ID,notification);
  }
  return updateViews;
}
