{
  AnkiDb.database.beginTransaction();
  try {
    String username=(String)data.data[0];
    String password=(String)data.data[1];
    Deck deck=(Deck)data.data[2];
    String deckPath=(String)data.data[3];
    String syncName=deck.getSyncName();
    Log.i(TAG,"Starting sync: username = " + username + ", password = "+ password+ ", deckPath = "+ deckPath+ ", syncName = "+ syncName);
    AnkiDroidProxy server=new AnkiDroidProxy(username,password);
    server.connect();
    if (!server.hasDeck(syncName)) {
      Log.i(TAG,"AnkiOnline does not have this deck: Creating it...");
      server.createDeck(syncName);
    }
    int timediff=(int)(server.getTimestamp() - (System.currentTimeMillis() / 1000));
    if (timediff > 300) {
      Log.i(TAG,"");
    }
    SyncClient client=new SyncClient(deck);
    client.setServer(server);
    server.setDeckName(syncName);
    if (client.prepareSync()) {
      JSONArray sums=client.summaries();
      if (client.needFullSync(sums)) {
        Log.i(TAG,"DECK NEEDS FULL SYNC");
        String syncFrom=client.prepareFullSync();
        if ("fromLocal".equalsIgnoreCase(syncFrom)) {
          SyncClient.fullSyncFromLocal(password,username,syncName,deckPath);
        }
 else         if ("fromServer".equalsIgnoreCase(syncFrom)) {
          SyncClient.fullSyncFromServer(password,username,syncName,deckPath);
        }
        AnkiDb.database.setTransactionSuccessful();
        AnkiDb.database.endTransaction();
        deck.closeDeck();
        deck=Deck.openDeck(deckPath);
        client.setDeck(deck);
      }
 else {
        Log.i(TAG,"DECK DOES NOT NEED FULL SYNC");
        JSONObject payload=client.genPayload(sums);
        JSONObject payloadReply=client.getServer().applyPayload(payload);
        client.applyPayloadReply(payloadReply);
        deck.lastLoaded=deck.modified;
        deck.commitToDB();
        AnkiDb.database.setTransactionSuccessful();
      }
    }
 else {
      Log.i(TAG,"NO CHANGES.");
    }
  }
 catch (  Exception e) {
    data.success=false;
    data.exception=e;
    Log.e(TAG,"Error synchronizing deck = " + e.getMessage());
    e.printStackTrace();
  }
 finally {
    if (AnkiDb.database.inTransaction()) {
      AnkiDb.database.endTransaction();
    }
  }
  return data;
}
