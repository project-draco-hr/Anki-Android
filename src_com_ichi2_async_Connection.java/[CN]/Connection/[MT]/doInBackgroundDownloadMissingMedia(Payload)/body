{
  HashMap<String,String> missingPaths=new HashMap<String,String>();
  HashMap<String,String> missingSums=new HashMap<String,String>();
  Deck deck=(Deck)data.data[0];
  data.result=deck;
  String syncName=deck.getDeckName();
  data.success=false;
  data.data=new Object[]{0,0,0};
  if (!deck.hasKey("mediaURL")) {
    data.success=true;
    return data;
  }
  String urlbase=deck.getVar("mediaURL");
  if (urlbase.equals("")) {
    data.success=true;
    return data;
  }
  String mdir=deck.mediaDir(true);
  int totalMissing=0;
  int missing=0;
  int grabbed=0;
  Cursor cursor=null;
  try {
    cursor=deck.getDB().getDatabase().rawQuery("SELECT filename, originalPath FROM media",null);
    String path=null;
    String f=null;
    while (cursor.moveToNext()) {
      f=cursor.getString(0);
      path=mdir + "/" + f;
      File file=new File(path);
      if (!file.exists()) {
        missingPaths.put(f,path);
        missingSums.put(f,cursor.getString(1));
      }
    }
  }
  finally {
    if (cursor != null) {
      cursor.close();
    }
  }
  totalMissing=missingPaths.size();
  data.data[0]=new Integer(totalMissing);
  if (totalMissing == 0) {
    data.success=true;
    return data;
  }
  publishProgress(Boolean.FALSE,new Integer(totalMissing),new Integer(0),syncName);
  URL url=null;
  HttpURLConnection connection=null;
  String path=null;
  String sum=null;
  int readbytes=0;
  byte[] buf=new byte[4096];
  for (  String file : missingPaths.keySet()) {
    try {
      android.net.Uri uri=android.net.Uri.parse(urlbase + Uri.encode(file));
      url=new URI(uri.toString()).toURL();
      connection=(HttpURLConnection)url.openConnection();
      connection.connect();
      if (connection.getResponseCode() == 200) {
        path=missingPaths.get(file);
        InputStream is=connection.getInputStream();
        BufferedInputStream bis=new BufferedInputStream(is,4096);
        FileOutputStream fos=new FileOutputStream(path);
        while ((readbytes=bis.read(buf,0,4096)) != -1) {
          fos.write(buf,0,readbytes);
        }
        fos.close();
        sum=missingSums.get(file);
        if (sum.equals("") || sum.equals(Utils.fileChecksum(path))) {
          grabbed++;
        }
 else {
          File f=new File(path);
          f.delete();
          missing++;
        }
      }
 else {
        Log.e(AnkiDroidApp.TAG,"Connection error (" + connection.getResponseCode() + ") while retrieving media file "+ urlbase+ file);
        Log.e(AnkiDroidApp.TAG,"Connection message: " + connection.getResponseMessage());
        if (missingSums.get(file).equals("")) {
          missing++;
        }
 else {
          data.success=false;
          data.data=new Object[]{file};
          return data;
        }
      }
      connection.disconnect();
    }
 catch (    URISyntaxException e) {
      Log.e(AnkiDroidApp.TAG,Log.getStackTraceString(e));
    }
catch (    MalformedURLException e) {
      Log.e(AnkiDroidApp.TAG,Log.getStackTraceString(e));
      Log.e(AnkiDroidApp.TAG,"MalformedURLException while download media file " + path);
      if (missingSums.get(file).equals("")) {
        missing++;
      }
 else {
        data.success=false;
        data.data=new Object[]{file};
        return data;
      }
    }
catch (    IOException e) {
      Log.e(AnkiDroidApp.TAG,Log.getStackTraceString(e));
      Log.e(AnkiDroidApp.TAG,"IOException while download media file " + path);
      if (missingSums.get(file).equals("")) {
        missing++;
      }
 else {
        data.success=false;
        data.data=new Object[]{file};
        return data;
      }
    }
 finally {
      if (connection != null) {
        connection.disconnect();
      }
    }
    publishProgress(Boolean.TRUE,new Integer(totalMissing),new Integer(grabbed + missing),syncName);
  }
  data.data[1]=new Integer(grabbed);
  data.data[2]=new Integer(missing);
  data.success=true;
  return data;
}
