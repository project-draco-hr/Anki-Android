{
  String hkey=(String)data.data[0];
  boolean media=(Boolean)data.data[1];
  String conflictResolution="upload";
  Collection col=Collection.currentCollection();
  String path=col.getPath();
  HttpSyncer server=new RemoteServer(hkey);
  Syncer client=new Syncer(col,server);
  boolean noChanges=false;
  if (conflictResolution == null) {
    Log.i(AnkiDroidApp.TAG,"Sync - starting sync");
    publishProgress(R.string.sync_prepare_syncing);
    Object[] ret=client.sync(this);
    String retCode=(String)ret[0];
    if (!retCode.equals("noChanges") && !retCode.equals("success")) {
      data.success=false;
      data.result=ret;
      return data;
    }
    col.save();
    if (retCode.equals("noChanges")) {
      noChanges=true;
    }
 else {
    }
  }
 else {
    try {
      server=new FullSyncer(col,hkey);
      if (conflictResolution.equals("upload")) {
        Log.i(AnkiDroidApp.TAG,"Sync - fullsync - upload collection");
        publishProgress(R.string.sync_preparing_full_sync_message);
        Object[] ret=server.upload(this);
        if (!((String)ret[0]).equals(HttpSyncer.ANKIWEB_STATUS_OK)) {
          data.success=false;
          data.result=ret;
          return data;
        }
      }
 else       if (conflictResolution.equals("download")) {
        Log.i(AnkiDroidApp.TAG,"Sync - fullsync - download collection");
        publishProgress(R.string.sync_downloading_message);
        Object[] ret=server.download();
        if (!((String)ret[0]).equals("success")) {
          data.success=false;
          data.result=ret;
          return data;
        }
      }
    }
  finally {
      publishProgress(R.string.sync_reload_message);
      col=Collection.openCollection(path);
    }
  }
  boolean noMediaChanges=true;
  if (media) {
  }
  if (noChanges && noMediaChanges) {
    data.success=false;
    data.result=new Object[]{"noChanges"};
    return data;
  }
 else {
    data.success=true;
    TreeSet<Object[]> decks=col.getSched().deckDueTree(true);
    data.result=decks;
    data.data=new Object[]{conflictResolution};
    return data;
  }
}
