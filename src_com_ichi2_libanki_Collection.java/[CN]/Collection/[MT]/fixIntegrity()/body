{
  File file=new File(mPath);
  long oldSize=file.length();
  try {
    mDb.getDatabase().beginTransaction();
    try {
      save();
      if (!mDb.queryString("PRAGMA integrity_check").equals("ok")) {
        return -1;
      }
      ArrayList<Long> ids=mDb.queryColumn(Long.class,"SELECT id FROM notes WHERE mid NOT IN " + Utils.ids2str(mModels.ids()),0);
      if (ids.size() != 0) {
        _remNotes(Utils.arrayList2array(ids));
      }
      ids=mDb.queryColumn(Long.class,"SELECT id FROM notes WHERE id NOT IN (SELECT DISTINCT nid FROM cards)",0);
      if (ids.size() != 0) {
        _remNotes(Utils.arrayList2array(ids));
      }
      mTags.registerNotes();
      for (      JSONObject m : mModels.all()) {
        updateFieldCache(Utils.arrayList2array(mModels.nids(m)));
      }
      mConf.put("nextPos",mDb.queryScalar("SELECT max(due) + 1 FROM cards WHERE type = 0",false));
      ids=mDb.queryColumn(Long.class,"SELECT id FROM cards WHERE queue = 2 AND due > 10000",0);
      if (ids.size() > 0) {
        mDb.execute("UPDATE cards SET due = 0, mod = " + Utils.intNow() + ", usn = "+ usn()+ " WHERE id IN "+ Utils.ids2str(Utils.arrayList2array(ids)));
      }
      mDb.getDatabase().setTransactionSuccessful();
    }
 catch (    JSONException e) {
      throw new RuntimeException(e);
    }
 finally {
      mDb.getDatabase().endTransaction();
    }
  }
 catch (  RuntimeException e) {
    Log.e(AnkiDroidApp.TAG,"doInBackgroundCheckDatabase - RuntimeException on marking card: " + e);
    AnkiDroidApp.saveExceptionReportFile(e,"doInBackgroundCheckDatabase");
    return -1;
  }
  optimize();
  file=new File(mPath);
  long newSize=file.length();
  return (long)((oldSize - newSize) / 1024);
}
