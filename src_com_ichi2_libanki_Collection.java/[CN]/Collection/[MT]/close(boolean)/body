{
  if (mDb != null) {
    cleanup();
    if (save) {
      getDb().getDatabase().beginTransaction();
      try {
        save();
        getDb().getDatabase().setTransactionSuccessful();
      }
  finally {
        getDb().getDatabase().endTransaction();
      }
    }
 else {
      if (getDb().getDatabase().inTransaction()) {
        getDb().getDatabase().endTransaction();
      }
      lock();
    }
    AnkiDatabaseManager.closeDatabase(mPath);
    mDb=null;
    mMedia.close();
    AnkiDroidApp.resetAccessThreadCount();
    Log.i(AnkiDroidApp.TAG,"Collection closed");
  }
}
