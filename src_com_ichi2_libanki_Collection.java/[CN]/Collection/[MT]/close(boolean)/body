{
  if (mDb != null) {
    cleanup();
    try {
      SQLiteDatabase db=getDb().getDatabase();
      if (save) {
        db.beginTransaction();
        try {
          save();
          db.setTransactionSuccessful();
        }
  finally {
          db.endTransaction();
        }
      }
 else {
        if (db.inTransaction()) {
          db.endTransaction();
        }
        lock();
      }
    }
 catch (    RuntimeException e) {
      AnkiDroidApp.saveExceptionReportFile(e,"closeDB");
    }
    AnkiDatabaseManager.closeDatabase(mPath);
    mDb=null;
    mMedia.close();
    AnkiDroidApp.resetAccessThreadCount();
    Log.i(AnkiDroidApp.TAG,"Collection closed");
  }
}
