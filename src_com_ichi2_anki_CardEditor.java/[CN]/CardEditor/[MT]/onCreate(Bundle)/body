{
  super.onCreate(savedInstanceState);
  registerExternalStorageListener();
  setContentView(R.layout.card_editor);
  mFieldsLayoutContainer=(LinearLayout)findViewById(R.id.CardEditorEditFieldsLayout);
  mSave=(Button)findViewById(R.id.CardEditorSaveButton);
  mCancel=(Button)findViewById(R.id.CardEditorCancelButton);
  mTags=(Button)findViewById(R.id.CardEditorTagButton);
  mTags=(Button)findViewById(R.id.CardEditorTagButton);
  mModelButtons=(LinearLayout)findViewById(R.id.CardEditorSelectModelLayout);
  mModelButton=(Button)findViewById(R.id.CardEditorModelButton);
  mTemplateButton=(Button)findViewById(R.id.CardEditorTemplateButton);
  mDeck=AnkiDroidApp.deck();
  mModels=mDeck.models();
  mCurrentModel=mDeck.currentModel();
switch (getIntent().getIntExtra(CARD_EDITOR_ACTION,ADD_CARD)) {
case EDIT_REVIEWER_CARD:
    mEditorFact=Reviewer.getEditorCard().getFact();
  break;
case EDIT_BROWSER_CARD:
mEditorFact=CardBrowser.getEditorCard().getFact();
break;
case ADD_CARD:
mAddFact=true;
mEditorFact=new Fact(mDeck,mCurrentModel);
mModelButtons.setVisibility(View.VISIBLE);
Resources res=getResources();
mSave.setText(res.getString(R.string.add));
mCancel.setText(res.getString(R.string.close));
mModelButton.setOnClickListener(new View.OnClickListener(){
public void onClick(View v){
showDialog(DIALOG_MODEL_SELECT);
}
}
);
mTemplateButton.setOnClickListener(new View.OnClickListener(){
public void onClick(View v){
templatesDialog().show();
}
}
);
break;
}
SharedPreferences preferences=PrefSettings.getSharedPrefs(getBaseContext());
mPrefFixArabic=preferences.getBoolean("fixArabicText",false);
mSave.setEnabled(!mPrefFixArabic);
initializeFactVariables();
mTags.setOnClickListener(new View.OnClickListener(){
@Override public void onClick(View v){
recreateTagsDialog();
if (!mTagsDialog.isShowing()) {
mTagsDialog.show();
}
}
}
);
mSave.setOnClickListener(new View.OnClickListener(){
@Override public void onClick(View v){
for (FieldEditText f : mEditFields) {
mModified|=f.updateField();
}
if (!mEditorFact.stringTags().equals(mFactTags)) {
mEditorFact.setTags(mFactTags);
mModified=true;
}
if (mModified) {
if (mAddFact) {
AnkiDroidApp.deck().addFact(mEditorFact);
}
 else {
mEditorFact.flush();
setResult(RESULT_OK);
finish();
}
}
 else {
setResult(RESULT_CANCELED);
}
}
}
);
mCancel.setOnClickListener(new View.OnClickListener(){
@Override public void onClick(View v){
setResult(RESULT_CANCELED);
closeCardEditor();
}
}
);
initDialogs();
modelChanged();
}
