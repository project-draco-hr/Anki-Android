{
  Log.i(AnkiDroidApp.TAG,"CardEditor: onCreate");
  Themes.applyTheme(this);
  super.onCreate(savedInstanceState);
  this.getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_HIDDEN);
  Intent intent=getIntent();
  if (savedInstanceState != null) {
    mCaller=savedInstanceState.getInt("caller");
    mAddNote=savedInstanceState.getBoolean("addFact");
  }
 else {
    mCaller=intent.getIntExtra(EXTRA_CALLER,CALLER_NOCALLER);
    if (mCaller == CALLER_NOCALLER) {
      String action=intent.getAction();
      if (action != null && (ACTION_CREATE_FLASHCARD.equals(action) || ACTION_CREATE_FLASHCARD_SEND.equals(action))) {
        mCaller=CALLER_INDICLASH;
      }
    }
  }
  Log.i(AnkiDroidApp.TAG,"CardEditor: caller: " + mCaller);
  SharedPreferences preferences=AnkiDroidApp.getSharedPrefs(getBaseContext());
  if (mCaller == CALLER_INDICLASH && preferences.getBoolean("intentAdditionInstantAdd",false)) {
    fetchIntentInformation(intent);
    MetaDB.saveIntentInformation(CardEditor.this,Utils.joinFields(mSourceText));
    Themes.showThemedToast(CardEditor.this,getResources().getString(R.string.app_name) + ": " + getResources().getString(R.string.CardEditorLaterMessage),false);
    finish();
    return;
  }
  mCol=AnkiDroidApp.getCol();
  if (mCol == null) {
    reloadCollection(savedInstanceState);
    return;
  }
  registerExternalStorageListener();
  View mainView=getLayoutInflater().inflate(R.layout.card_editor,null);
  setContentView(mainView);
  Themes.setWallpaper(mainView);
  Themes.setContentStyle(mainView,Themes.CALLER_CARD_EDITOR);
  mFieldsLayoutContainer=(LinearLayout)findViewById(R.id.CardEditorEditFieldsLayout);
  mSave=(Button)findViewById(R.id.CardEditorSaveButton);
  mCancel=(Button)findViewById(R.id.CardEditorCancelButton);
  mLater=(Button)findViewById(R.id.CardEditorLaterButton);
  mPreviewButton=(Button)findViewById(R.id.CardEditorPreviewButton);
  mDeckButton=(TextView)findViewById(R.id.CardEditorDeckText);
  mModelButton=(TextView)findViewById(R.id.CardEditorModelText);
  mTagsButton=(TextView)findViewById(R.id.CardEditorTagText);
  mSwapButton=(Button)findViewById(R.id.CardEditorSwapButton);
  mSwapButton.setOnClickListener(new View.OnClickListener(){
    public void onClick(    View v){
      swapText(false);
    }
  }
);
  if (Preferences.COMING_FROM_ADD) {
    mPreviewButton.setVisibility(View.GONE);
  }
 else {
    mPreviewButton.setVisibility(View.VISIBLE);
  }
  Preferences.COMING_FROM_ADD=false;
  mAedictIntent=false;
switch (mCaller) {
case CALLER_NOCALLER:
    Log.i(AnkiDroidApp.TAG,"CardEditor: no caller could be identified, closing");
  finish();
return;
case CALLER_REVIEWER:
mCurrentEditedCard=Reviewer.getEditorCard();
if (mCurrentEditedCard == null) {
finish();
return;
}
mEditorNote=mCurrentEditedCard.note();
mAddNote=false;
break;
case CALLER_STUDYOPTIONS:
case CALLER_DECKPICKER:
mAddNote=true;
break;
case CALLER_BIGWIDGET_EDIT:
break;
case CALLER_BIGWIDGET_ADD:
mAddNote=true;
break;
case CALLER_CARDBROWSER_EDIT:
mCurrentEditedCard=CardBrowser.sCardBrowserCard;
if (mCurrentEditedCard == null) {
finish();
return;
}
mEditorNote=mCurrentEditedCard.note();
mAddNote=false;
break;
case CALLER_CARDBROWSER_ADD:
mAddNote=true;
break;
case CALLER_CARDEDITOR:
mAddNote=true;
break;
case CALLER_CARDEDITOR_INTENT_ADD:
mAddNote=true;
break;
case CALLER_INDICLASH:
fetchIntentInformation(intent);
if (mSourceText == null) {
finish();
return;
}
if (mSourceText[0].equals("Aedict Notepad") && addFromAedict(mSourceText[1])) {
finish();
return;
}
mAddNote=true;
break;
}
setNote(mEditorNote);
if (mAddNote) {
setTitle(R.string.cardeditor_title_add_note);
String contents=null;
if (mSourceText != null) {
if (mAedictIntent && (mEditFields.size() == 3) && mSourceText[1].contains("[")) {
contents=mSourceText[1].replaceFirst("\\[","\u001f" + mSourceText[0] + "\u001f");
contents=contents.substring(0,contents.length() - 1);
}
 else {
mEditFields.get(0).setText(mSourceText[0]);
mEditFields.get(1).setText(mSourceText[1]);
}
}
 else {
contents=intent.getStringExtra(EXTRA_CONTENTS);
}
if (contents != null) {
setEditFieldTexts(contents);
}
LinearLayout modelButton=((LinearLayout)findViewById(R.id.CardEditorModelButton));
modelButton.setOnClickListener(new View.OnClickListener(){
public void onClick(View v){
showDialog(DIALOG_MODEL_SELECT);
}
}
);
modelButton.setVisibility(View.VISIBLE);
mSave.setText(getResources().getString(R.string.add));
mCancel.setText(getResources().getString(R.string.close));
mLater.setVisibility(View.VISIBLE);
mLater.setOnClickListener(new View.OnClickListener(){
@Override public void onClick(View v){
String content=getFieldsText();
if (content.length() > mEditFields.size() - 1) {
MetaDB.saveIntentInformation(CardEditor.this,content);
populateEditFields();
mSourceText=null;
Themes.showThemedToast(CardEditor.this,getResources().getString(R.string.CardEditorLaterMessage),false);
}
if (mCaller == CALLER_INDICLASH || mCaller == CALLER_CARDEDITOR_INTENT_ADD) {
closeCardEditor();
}
}
}
);
}
 else {
setTitle(R.string.cardeditor_title_edit_card);
mSwapButton.setVisibility(View.GONE);
mSwapButton=(Button)findViewById(R.id.CardEditorLaterButton);
mSwapButton.setVisibility(View.VISIBLE);
mSwapButton.setText(getResources().getString(R.string.fact_adder_swap));
mSwapButton.setOnClickListener(new View.OnClickListener(){
public void onClick(View v){
swapText(false);
}
}
);
}
((LinearLayout)findViewById(R.id.CardEditorDeckButton)).setOnClickListener(new View.OnClickListener(){
public void onClick(View v){
showDialog(DIALOG_DECK_SELECT);
}
}
);
mPrefFixArabic=preferences.getBoolean("fixArabicText",false);
if (mPrefFixArabic && !mAddNote) {
mSave.setEnabled(false);
}
((LinearLayout)findViewById(R.id.CardEditorTagButton)).setOnClickListener(new View.OnClickListener(){
@Override public void onClick(View v){
showDialog(DIALOG_TAGS_SELECT);
}
}
);
mSave.setOnClickListener(new View.OnClickListener(){
@Override public void onClick(View v){
if (duplicateCheck(true)) {
showDialog(DIALOG_CONFIRM_DUPLICATE);
}
boolean modified=false;
for (FieldEditText f : mEditFields) {
modified=modified | f.updateField();
}
if (mAddNote) {
mEditorNote.setTags(mCurrentTags);
try {
JSONArray ja=new JSONArray();
for (String t : mCurrentTags) {
ja.put(t);
}
mCol.getModels().current().put("tags",ja);
mCol.getModels().setChanged();
}
 catch (JSONException e) {
throw new RuntimeException(e);
}
DeckTask.launchDeckTask(DeckTask.TASK_TYPE_ADD_FACT,mSaveFactHandler,new DeckTask.TaskData(mEditorNote));
}
 else {
saveNote();
}
}
}
);
mCancel.setOnClickListener(new View.OnClickListener(){
@Override public void onClick(View v){
closeCardEditor();
}
}
);
mPreviewButton.setOnClickListener(new View.OnClickListener(){
@Override public void onClick(View v){
openReviewer();
}
}
);
}
