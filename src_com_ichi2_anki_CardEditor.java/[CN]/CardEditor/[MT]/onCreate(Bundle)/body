{
  Log.i(AnkiDroidApp.TAG,"CardEditor: onCreate");
  Themes.applyTheme(this);
  super.onCreate(savedInstanceState);
  registerExternalStorageListener();
  View mainView=getLayoutInflater().inflate(R.layout.card_editor,null);
  setContentView(mainView);
  Themes.setWallpaper(mainView);
  Themes.setContentStyle(mainView,Themes.CALLER_CARD_EDITOR);
  mFieldsLayoutContainer=(LinearLayout)findViewById(R.id.CardEditorEditFieldsLayout);
  setTitle(R.string.cardeditor_title);
  mSave=(Button)findViewById(R.id.CardEditorSaveButton);
  mCancel=(Button)findViewById(R.id.CardEditorCancelButton);
  mSwapButton=(Button)findViewById(R.id.CardEditorSwapButton);
  mModelButtons=(LinearLayout)findViewById(R.id.CardEditorSelectModelLayout);
  mModelButton=(Button)findViewById(R.id.CardEditorModelButton);
  mTags=(Button)findViewById(R.id.CardEditorTagButton);
  mAedictIntent=false;
  Intent intent=getIntent();
  if (savedInstanceState != null) {
    mDeckPath=savedInstanceState.getString("deckFilename");
    mCaller=savedInstanceState.getInt("caller");
    mAddNote=savedInstanceState.getBoolean("addFact");
    Log.i(AnkiDroidApp.TAG,"onCreate - deckFilename from savedInstanceState: " + mDeckPath);
  }
 else {
    mCaller=intent.getIntExtra(EXTRA_CALLER,CALLER_NOCALLER);
    if (mCaller == CALLER_NOCALLER) {
      String action=intent.getAction();
      if (action != null && (ACTION_CREATE_FLASHCARD.equals(action) || ACTION_CREATE_FLASHCARD_SEND.equals(action))) {
        mCaller=CALLER_INDICLASH;
      }
    }
  }
  Log.i(AnkiDroidApp.TAG,"Caller: " + mCaller);
switch (mCaller) {
case CALLER_NOCALLER:
    Log.i(AnkiDroidApp.TAG,"CardEditor: no caller could be identified, closing");
  finish();
return;
case CALLER_REVIEWER:
Card revCard=Reviewer.getEditorCard();
if (revCard == null) {
finish();
return;
}
mEditorNote=revCard.getNote();
mAddNote=false;
break;
case CALLER_STUDYOPTIONS:
mAddNote=true;
break;
case CALLER_BIGWIDGET_EDIT:
break;
case CALLER_BIGWIDGET_ADD:
mAddNote=true;
break;
case CALLER_CARDBROWSER_EDIT:
break;
case CALLER_CARDBROWSER_ADD:
mAddNote=true;
break;
case CALLER_CARDEDITOR:
mAddNote=true;
break;
case CALLER_CARDEDITOR_INTENT_ADD:
prepareForIntentAddition();
mAddNote=true;
String[] fields=intent.getStringExtra(EXTRA_CONTENTS).split("\\x1f");
mSourceText=fields[0];
mTargetText=fields[1];
break;
case CALLER_INDICLASH:
Bundle extras=intent.getExtras();
if (ACTION_CREATE_FLASHCARD.equals(intent.getAction())) {
mSourceText=extras.getString(SOURCE_TEXT);
mTargetText=extras.getString(TARGET_TEXT);
}
 else {
mSourceText=extras.getString(Intent.EXTRA_SUBJECT);
mTargetText=extras.getString(Intent.EXTRA_TEXT);
}
if (mSourceText == null && mTargetText == null) {
finish();
return;
}
if (mSourceText.equals("Aedict Notepad") && addFromAedict(mTargetText)) {
finish();
return;
}
prepareForIntentAddition();
mAddNote=true;
break;
}
mCol=Collection.currentCollection();
if (mCol == null) {
finish();
return;
}
if (mAddNote) {
if (mCaller != CALLER_INDICLASH && mCaller != CALLER_CARDEDITOR_INTENT_ADD) {
loadContents();
modelChanged();
mSave.setEnabled(false);
String contents=intent.getStringExtra(EXTRA_CONTENTS);
setEditFieldTexts(contents);
mModelButtons.setVisibility(View.VISIBLE);
}
 else {
mSave.setVisibility(View.INVISIBLE);
mCancel.setVisibility(View.INVISIBLE);
mTags.setVisibility(View.INVISIBLE);
mFieldsLayoutContainer.setVisibility(View.INVISIBLE);
}
mModelButton.setOnClickListener(new View.OnClickListener(){
public void onClick(View v){
showDialog(DIALOG_MODEL_SELECT);
}
}
);
mSave.setText(getResources().getString(R.string.add));
mCancel.setText(getResources().getString(R.string.close));
mFactTags="";
}
 else {
}
mTags.setText(getResources().getString(R.string.CardEditorTags,mFactTags));
mModified=false;
SharedPreferences preferences=PrefSettings.getSharedPrefs(getBaseContext());
mPrefFixArabic=preferences.getBoolean("fixArabicText",false);
if (mPrefFixArabic && !mAddNote) {
mSave.setEnabled(false);
}
mTags.setOnClickListener(new View.OnClickListener(){
@Override public void onClick(View v){
showDialog(DIALOG_TAGS);
}
}
);
allTags=null;
mSelectedTags=new HashSet<String>();
mSave.setOnClickListener(new View.OnClickListener(){
@Override public void onClick(View v){
if (mAddNote) {
boolean empty=true;
for (FieldEditText current : mEditFields) {
current.updateField();
if (current.getText().length() != 0) {
empty=false;
}
}
if (!empty) {
}
 else {
if (!mCardReset) {
setResult(RESULT_CANCELED);
}
}
}
 else {
Iterator<FieldEditText> iter=mEditFields.iterator();
while (iter.hasNext()) {
FieldEditText current=iter.next();
mModified|=current.updateField();
}
if (mCaller == CALLER_BIGWIDGET_EDIT) {
}
 else if (!mCardReset) {
if (mModified) {
setResult(RESULT_OK);
}
 else {
setResult(RESULT_CANCELED);
}
closeCardEditor();
}
}
}
}
);
mCancel.setOnClickListener(new View.OnClickListener(){
@Override public void onClick(View v){
if (!mCardReset) {
setResult(RESULT_CANCELED);
}
closeCardEditor();
}
}
);
if (!mAddNote) {
populateEditFields();
}
}
