{
  if (mAddNote) {
    for (    FieldEditText f : mEditFields) {
      f.updateField();
    }
    try {
      mEditorNote.model().put("did",mCurrentDid);
      mEditorNote.setTagsFromStr(tagsAsString(mCurrentTags));
      JSONArray ja=new JSONArray();
      for (      String t : mCurrentTags) {
        ja.put(t);
      }
      mCol.getModels().current().put("tags",ja);
      mCol.getModels().setChanged();
    }
 catch (    JSONException e) {
      throw new RuntimeException(e);
    }
    DeckTask.launchDeckTask(DeckTask.TASK_TYPE_ADD_FACT,mSaveFactHandler,new DeckTask.TaskData(mEditorNote));
  }
 else {
    boolean modified=false;
    if (mCurrentEditedCard.getDid() != mCurrentDid) {
      AnkiDroidApp.getCol().getSched().remFromDyn(new long[]{mCurrentEditedCard.getId()});
      mCurrentEditedCard.load();
      mEditorNote=mCurrentEditedCard.note();
      mCurrentEditedCard.setDid(mCurrentDid);
      modified=true;
    }
    for (    FieldEditText f : mEditFields) {
      modified=modified | f.updateField();
    }
    for (    String t : mCurrentTags) {
      modified=modified || !mEditorNote.hasTag(t);
    }
    modified=modified || mEditorNote.getTags().size() > mCurrentTags.size();
    if (modified) {
      mEditorNote.setTagsFromStr(tagsAsString(mCurrentTags));
      mChanged=true;
    }
    closeCardEditor();
  }
}
