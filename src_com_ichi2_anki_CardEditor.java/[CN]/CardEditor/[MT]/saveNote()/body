{
  boolean modified=false;
  for (  FieldEditText f : mEditFields) {
    modified=modified | f.updateField();
  }
  if (mAddNote) {
    try {
      mEditorNote.model().put("did",mCurrentDid);
      mEditorNote.setTagsFromStr(tagsAsString(mCurrentTags));
      JSONArray ja=new JSONArray();
      for (      String t : mCurrentTags) {
        ja.put(t);
      }
      mCol.getModels().current().put("tags",ja);
      mCol.getModels().setChanged();
    }
 catch (    JSONException e) {
      throw new RuntimeException(e);
    }
    DeckTask.launchDeckTask(DeckTask.TASK_TYPE_ADD_FACT,mSaveFactHandler,new DeckTask.TaskData(mEditorNote));
  }
 else {
    for (    String t : mCurrentTags) {
      modified=modified || !mEditorNote.hasTag(t);
    }
    modified=modified || mEditorNote.getTags().size() > mCurrentTags.size();
    boolean changedDid=mCurrentEditedCard.getDid() != mCurrentDid;
    modified=modified || changedDid;
    if (modified) {
      mEditorNote.setTagsFromStr(tagsAsString(mCurrentTags));
      if (changedDid) {
        AnkiDroidApp.getCol().getSched().remFromDyn(new long[]{mCurrentEditedCard.getId()});
        mCurrentEditedCard.load();
        mCurrentEditedCard.setDid(mCurrentDid);
      }
      mChanged=true;
    }
    closeCardEditor();
  }
}
