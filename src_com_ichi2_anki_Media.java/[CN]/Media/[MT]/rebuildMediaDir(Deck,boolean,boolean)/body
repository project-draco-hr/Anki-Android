{
  String mdir=deck.mediaDir();
  if (mdir == null) {
    return;
  }
  deck.getDB().getDatabase().execSQL("UPDATE media SET size = 0");
  Cursor cursor=null;
  String txt=null;
  Map<String,Integer> refs=new HashMap<String,Integer>();
  Set<String> normrefs=new HashSet<String>();
  try {
    cursor=deck.getDB().getDatabase().rawQuery("SELECT question, answer FROM cards",null);
    while (cursor.moveToNext()) {
      for (int i=0; i < 2; i++) {
        txt=cursor.getString(i);
        for (        String f : mediaFiles(txt)) {
          if (refs.containsKey(f)) {
            refs.put(f,refs.get(f) + 1);
          }
 else {
            refs.put(f,1);
            normrefs.add(f);
          }
        }
      }
    }
  }
  finally {
    if (cursor != null) {
      cursor.close();
    }
  }
  for (  String fname : refs.keySet()) {
    updateMediaCount(deck,fname,refs.get(fname));
  }
  String fname=null;
  if (mdir != null) {
    Set<String> unused=new HashSet<String>();
    File mdirfile=new File(mdir);
    if (mdirfile.exists()) {
      fname=null;
      for (      File f : mdirfile.listFiles()) {
        if (!f.isFile()) {
          continue;
        }
        fname=f.getName();
        if (!normrefs.contains(fname)) {
          unused.add(fname);
        }
      }
    }
    if (delete) {
      for (      String fn : unused) {
        File file=new File(mdir + "/" + fn);
        try {
          if (!file.delete()) {
            Log.e(AnkiDroidApp.TAG,"Couldn't delete unused media file " + mdir + "/"+ fn);
          }
        }
 catch (        SecurityException e) {
          Log.e(AnkiDroidApp.TAG,"Security exception while deleting unused media file " + mdir + "/"+ fn);
        }
      }
    }
  }
  removeUnusedMedia(deck);
  cursor=null;
  String path=null;
  fname=null;
  String md5=null;
  deck.getDB().getDatabase().beginTransaction();
  try {
    cursor=deck.getDB().getDatabase().rawQuery("SELECT filename, created, originalPath FROM media",null);
    while (cursor.moveToNext()) {
      fname=cursor.getString(0);
      md5=cursor.getString(2);
      path=mdir + "/" + fname;
      File file=new File(path);
      if (!file.exists()) {
        if (!md5.equals("")) {
          deck.getDB().getDatabase().execSQL("UPDATE media SET originalPath = '', created = " + cursor.getString(1) + " where filename = '"+ fname+ "'");
        }
      }
 else {
        String sum=Utils.fileChecksum(path);
        if (!md5.equals(sum)) {
          deck.getDB().getDatabase().execSQL("UPDATE media SET originalPath = '" + sum + "', created = "+ cursor.getString(1)+ " where filename = '"+ fname+ "'");
        }
      }
    }
  }
  finally {
    if (cursor != null) {
      cursor.close();
    }
  }
  deck.getDB().getDatabase().setTransactionSuccessful();
  deck.getDB().getDatabase().endTransaction();
  if (dirty) {
    deck.flushMod();
  }
}
