{
  Deck deck=params[0].getDeck();
  Card currentCard=params[0].getCard();
  try {
    AnkiDb ankiDB=AnkiDatabaseManager.getDatabase(deck.getDeckPath());
    ankiDB.getDatabase().beginTransaction();
    try {
      if (currentCard != null) {
        String undoName=Deck.UNDO_TYPE_MARK_CARD;
        deck.setUndoStart(undoName,currentCard.getId());
        if (currentCard.isMarked()) {
          deck.deleteTag(currentCard.getFactId(),Deck.TAG_MARKED);
        }
 else {
          deck.addTag(currentCard.getFactId(),Deck.TAG_MARKED);
        }
        deck.resetMarkedTagId();
        deck.setUndoEnd(undoName);
      }
      publishProgress(new TaskData(currentCard));
      ankiDB.getDatabase().setTransactionSuccessful();
    }
  finally {
      ankiDB.getDatabase().endTransaction();
    }
  }
 catch (  RuntimeException e) {
    Log.e(AnkiDroidApp.TAG,"doInBackgroundMarkCard - RuntimeException on marking card: " + e);
    AnkiDroidApp.saveExceptionReportFile(e);
    return new TaskData(false);
  }
  return new TaskData(true);
}
