{
  Timber.d("buildUpdate");
  RemoteViews updateViews=new RemoteViews(context.getPackageName(),R.layout.widget_small);
  boolean mounted=AnkiDroidApp.isSdCardMounted();
  if (!mounted) {
    updateViews.setViewVisibility(R.id.widget_due,View.INVISIBLE);
    updateViews.setViewVisibility(R.id.widget_eta,View.INVISIBLE);
    updateViews.setViewVisibility(R.id.widget_progress_frame,View.INVISIBLE);
    updateViews.setViewVisibility(R.id.ankidroid_widget_small_finish_layout,View.GONE);
    if (mMountReceiver == null) {
      mMountReceiver=new BroadcastReceiver(){
        @Override public void onReceive(        Context context,        Intent intent){
          String action=intent.getAction();
          if (action.equals(Intent.ACTION_MEDIA_MOUNTED)) {
            Timber.d("mMountReceiver - Action = Media Mounted");
            if (remounted) {
              WidgetStatus.update(getBaseContext());
              remounted=false;
              if (mMountReceiver != null) {
                unregisterReceiver(mMountReceiver);
              }
            }
 else {
              remounted=true;
            }
          }
        }
      }
;
      IntentFilter iFilter=new IntentFilter();
      iFilter.addAction(Intent.ACTION_MEDIA_MOUNTED);
      iFilter.addDataScheme("file");
      registerReceiver(mMountReceiver,iFilter);
    }
  }
 else {
    if (dueCardsCount == 0 || updateDueDecksNow) {
      int[] counts=WidgetStatus.fetchSmall(context);
      progress=counts[0];
      dueCardsCount=counts[1];
      eta=counts[2];
      if (dueCardsCount <= 0) {
        if (dueCardsCount == 0) {
          updateViews.setViewVisibility(R.id.ankidroid_widget_small_finish_layout,View.VISIBLE);
        }
 else {
          updateViews.setViewVisibility(R.id.ankidroid_widget_small_finish_layout,View.INVISIBLE);
        }
        updateViews.setViewVisibility(R.id.widget_due,View.INVISIBLE);
        updateViews.setViewVisibility(R.id.widget_progress_frame,View.INVISIBLE);
      }
 else {
        updateViews.setViewVisibility(R.id.ankidroid_widget_small_finish_layout,View.INVISIBLE);
        updateViews.setViewVisibility(R.id.widget_due,View.VISIBLE);
        updateViews.setViewVisibility(R.id.widget_progress_frame,View.VISIBLE);
        updateViews.setTextViewText(R.id.widget_due,Integer.toString(dueCardsCount));
        updateViews.setProgressBar(R.id.widget_progress,1000,progress,false);
      }
      if (eta <= 0 || dueCardsCount <= 0) {
        updateViews.setViewVisibility(R.id.widget_eta,View.INVISIBLE);
      }
 else {
        updateViews.setViewVisibility(R.id.widget_eta,View.VISIBLE);
        updateViews.setTextViewText(R.id.widget_eta,Integer.toString(eta));
      }
    }
  }
  Intent ankiDroidIntent=new Intent(context,DeckPicker.class);
  ankiDroidIntent.setAction(Intent.ACTION_MAIN);
  ankiDroidIntent.addCategory(Intent.CATEGORY_LAUNCHER);
  PendingIntent pendingAnkiDroidIntent=PendingIntent.getActivity(context,0,ankiDroidIntent,PendingIntent.FLAG_UPDATE_CURRENT);
  updateViews.setOnClickPendingIntent(R.id.ankidroid_widget_small_button,pendingAnkiDroidIntent);
  AppWidgetManager manager=AppWidgetManager.getInstance(context);
  int[] ids=manager.getAppWidgetIds(new ComponentName(this,AnkiDroidWidgetSmall.class));
  for (  int id : ids) {
    AppWidgetProviderInfo providerInfo=manager.getAppWidgetInfo(id);
    final float scale=getResources().getDisplayMetrics().density;
    float scaledDensity=context.getResources().getDisplayMetrics().scaledDensity;
    int[] dimensions=AnkiDroidApp.getCompat().getWidgetDimensions(manager,id);
    if (dimensions != null && dimensions.length == 4) {
      float width, height;
      if (context.getResources().getConfiguration().orientation == Configuration.ORIENTATION_PORTRAIT) {
        width=dimensions[0];
        height=dimensions[3];
      }
 else {
        width=dimensions[1];
        height=dimensions[2];
      }
      int horizontal, vertical;
      float text;
      if ((width / height) > 0.8) {
        horizontal=(int)(((width - (height * 0.8)) / 2 + 4) * scale + 0.5f);
        vertical=(int)(4 * scale + 0.5f);
        text=(float)(Math.sqrt(height * 0.8 / width) * 18);
      }
 else {
        vertical=(int)(((height - (width * 1.25)) / 2 + 4) * scale + 0.5f);
        horizontal=(int)(4 * scale + 0.5f);
        text=(float)(Math.sqrt(width * 1.25 / height) * 18);
      }
      AnkiDroidApp.getCompat().adjustSmallWidgetDimensions(updateViews,R.id.ankidroid_widget_text_layout,horizontal,vertical,horizontal,vertical,text);
    }
  }
  return updateViews;
}
