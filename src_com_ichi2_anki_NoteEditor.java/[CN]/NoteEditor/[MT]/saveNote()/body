{
  if (mSelectedTags == null) {
    mSelectedTags=new ArrayList<String>();
  }
  if (mAddNote) {
    for (    FieldEditText f : mEditFields) {
      updateField(f);
    }
    try {
      mEditorNote.model().put("did",mCurrentDid);
      mEditorNote.setTagsFromStr(tagsAsString(mSelectedTags));
      JSONArray ja=new JSONArray();
      for (      String t : mSelectedTags) {
        ja.put(t);
      }
      getCol().getModels().current().put("tags",ja);
      getCol().getModels().setChanged();
    }
 catch (    JSONException e) {
      throw new RuntimeException(e);
    }
    DeckTask.launchDeckTask(DeckTask.TASK_TYPE_ADD_FACT,mSaveFactHandler,new DeckTask.TaskData(mEditorNote));
  }
 else {
    boolean modified=false;
    if (mCurrentEditedCard.getDid() != mCurrentDid) {
      AnkiDroidApp.getCol().getSched().remFromDyn(new long[]{mCurrentEditedCard.getId()});
      mCurrentEditedCard.load();
      mEditorNote=mCurrentEditedCard.note();
      mCurrentEditedCard.setDid(mCurrentDid);
      modified=true;
    }
    for (    FieldEditText f : mEditFields) {
      modified=modified | updateField(f);
    }
    for (    String t : mSelectedTags) {
      modified=modified || !mEditorNote.hasTag(t);
    }
    modified=modified || mEditorNote.getTags().size() > mSelectedTags.size();
    if (modified) {
      mEditorNote.setTagsFromStr(tagsAsString(mSelectedTags));
      mChanged=true;
    }
    closeCardEditor();
  }
}
