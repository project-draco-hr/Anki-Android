{
  Themes.applyTheme(this);
  super.onCreate(savedInstanceState);
  View mainView=getLayoutInflater().inflate(R.layout.card_browser,null);
  setContentView(mainView);
  Themes.setContentStyle(mainView,Themes.CALLER_CARDBROWSER);
  mCol=AnkiDroidApp.getCol();
  if (mCol == null) {
    reloadCollection(savedInstanceState);
    return;
  }
  mDeckNames=new HashMap<String,String>();
  for (  long did : mCol.getDecks().allIds()) {
    mDeckNames.put(String.valueOf(did),mCol.getDecks().name(did));
  }
  registerExternalStorageListener();
  Intent i=getIntent();
  mWholeCollection=i.hasExtra("fromDeckpicker") && i.getBooleanExtra("fromDeckpicker",false);
  mBackground=Themes.getCardBrowserBackground();
  SharedPreferences preferences=AnkiDroidApp.getSharedPrefs(getBaseContext());
  int sflRelativeFontSize=preferences.getInt("relativeCardBrowserFontSize",DEFAULT_FONT_SIZE_RATIO);
  String sflCustomFont=preferences.getString("browserEditorFont","");
  mPrefFixArabic=preferences.getBoolean("fixArabicText",false);
  mPrefCacheCardBrowser=preferences.getBoolean("cardBrowserCache",false);
  Resources res=getResources();
  mOrderByFields=res.getStringArray(R.array.card_browser_order_labels);
  try {
    mOrder=CARD_ORDER_NONE;
    String colOrder=mCol.getConf().getString("sortType");
    for (int c=0; c < fSortTypes.length; ++c) {
      if (fSortTypes[c].equals(colOrder)) {
        mOrder=c;
        break;
      }
    }
    mOrderAsc=Upgrade.upgradeJSONIfNecessary(mCol,mCol.getConf(),"sortBackwards",false);
    if (fSortTypes[mOrder].equals("noteFld")) {
      mOrderAsc=!mOrderAsc;
    }
  }
 catch (  JSONException e) {
    throw new RuntimeException(e);
  }
  mCards=new ArrayList<HashMap<String,String>>();
  mCardsListView=(ListView)findViewById(R.id.card_browser_list);
  mCardsAdapter=new SizeControlledListAdapter(this,mCards,R.layout.card_item,new String[]{"sfld","deck","flags"},new int[]{R.id.card_sfld,R.id.card_deck,R.id.card_item},sflRelativeFontSize,sflCustomFont);
  mCardsAdapter.setViewBinder(new SimpleAdapter.ViewBinder(){
    @Override public boolean setViewValue(    View view,    Object arg1,    String text){
      if (view.getId() == R.id.card_item) {
        int which=BACKGROUND_NORMAL;
        if (text.equals("1")) {
          which=BACKGROUND_SUSPENDED;
        }
 else         if (text.equals("2")) {
          which=BACKGROUND_MARKED;
        }
 else         if (text.equals("3")) {
          which=BACKGROUND_MARKED_SUSPENDED;
        }
        view.setBackgroundResource(mBackground[which]);
        return true;
      }
 else       if (view.getId() == R.id.card_deck && text.length() > 0) {
        view.setVisibility(View.VISIBLE);
      }
      return false;
    }
  }
);
  mCardsListView.setAdapter(mCardsAdapter);
  mCardsListView.setOnItemClickListener(new OnItemClickListener(){
    @Override public void onItemClick(    AdapterView<?> parent,    View view,    int position,    long id){
      Intent editCard=new Intent(CardBrowser.this,CardEditor.class);
      editCard.putExtra(CardEditor.EXTRA_CALLER,CardEditor.CALLER_CARDBROWSER_EDIT);
      mPositionInCardsList=position;
      long cardId=Long.parseLong(mCards.get(mPositionInCardsList).get("id"));
      sCardBrowserCard=mCol.getCard(cardId);
      startActivityForResult(editCard,EDIT_CARD);
      if (AnkiDroidApp.SDK_VERSION > 4) {
        ActivityTransitionAnimation.slide(CardBrowser.this,ActivityTransitionAnimation.LEFT);
      }
    }
  }
);
  registerForContextMenu(mCardsListView);
  mSearchEditText=(EditText)findViewById(R.id.card_browser_search);
  getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_HIDDEN);
  mSearchButton=(ImageButton)findViewById(R.id.card_browser_search_button);
  mSearchButton.setOnClickListener(new View.OnClickListener(){
    @Override public void onClick(    View v){
      mSearchTerms=mSearchEditText.getText().toString().toLowerCase();
      if (mSearchTerms.length() == 0) {
        mSearchEditText.setHint(R.string.downloaddeck_search);
      }
      searchCards();
    }
  }
);
  mSearchTerms="";
  if (mWholeCollection) {
    mRestrictOnDeck="";
    setTitle(res.getString(R.string.card_browser_all_decks));
  }
 else {
    try {
      String deckName=mCol.getDecks().current().getString("name");
      mRestrictOnDeck="deck:'" + deckName + "' ";
      setTitle(deckName);
    }
 catch (    JSONException e) {
      throw new RuntimeException(e);
    }
  }
  mSelectedTags=new HashSet<String>();
  searchCards();
}
