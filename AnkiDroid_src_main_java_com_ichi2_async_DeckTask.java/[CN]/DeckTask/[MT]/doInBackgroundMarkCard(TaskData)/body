{
  Card card=params[0].getCard();
  Sched sched=params[0].getSched();
  try {
    AnkiDb ankiDB=sched.getCol().getDb();
    ankiDB.getDatabase().beginTransaction();
    try {
      if (card != null) {
        Note note=card.note();
        sched.getCol().markUndo(Collection.UNDO_MARK_NOTE,new Object[]{note.getId(),note.stringTags(),card.getId()});
        if (note.hasTag("marked")) {
          note.delTag("marked");
        }
 else {
          note.addTag("marked");
        }
        note.flush();
      }
      publishProgress(new TaskData(card));
      ankiDB.getDatabase().setTransactionSuccessful();
    }
  finally {
      ankiDB.getDatabase().endTransaction();
    }
  }
 catch (  RuntimeException e) {
    Timber.e(e,"doInBackgroundMarkCard - RuntimeException on marking card");
    AnkiDroidApp.sendExceptionReport(e,"doInBackgroundMarkCard");
    return new TaskData(false);
  }
  return new TaskData(true);
}
