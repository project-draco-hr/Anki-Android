{
  HttpResponse ret=super.req("download");
  InputStream cont;
  try {
    cont=ret.getEntity().getContent();
  }
 catch (  IllegalStateException e1) {
    throw new RuntimeException(e1);
  }
catch (  IOException e1) {
    throw new RuntimeException(e1);
  }
  String path=mCol.getPath();
  mCol.close();
  mCol=null;
  String tpath=path + ".tmp";
  try {
    Utils.writeToFile(cont,tpath);
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
  try {
    AnkiDb d=AnkiDatabaseManager.getDatabase(tpath);
    Cursor cur=null;
    try {
      cur=d.getDatabase().rawQuery("PRAGMA integrity_check",null);
      if (!cur.moveToFirst() || !cur.getString(0).equals("ok")) {
        Log.e(AnkiDroidApp.TAG,"Full sync - downloaded file corrupt");
        return null;
      }
    }
  finally {
      if (cur != null && !cur.isClosed()) {
        cur.close();
      }
    }
    AnkiDatabaseManager.closeDatabase(tpath);
  }
 catch (  SQLiteDatabaseCorruptException e) {
    return null;
  }
  connection.publishProgress(R.string.sync_complete_message);
  File newFile=new File(tpath);
  if (newFile.renameTo(new File(path))) {
    return ret;
  }
 else {
    return null;
  }
}
