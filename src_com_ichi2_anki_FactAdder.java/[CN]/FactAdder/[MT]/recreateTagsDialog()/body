{
  Resources res=getResources();
  if (allTags == null) {
    String[] oldTags=mDeck.allUserTags();
    Log.i(AnkiDroidApp.TAG,"all tags: " + Arrays.toString(oldTags));
    allTags=new String[oldTags.length + 1];
    allTags[0]=res.getString(R.string.add_new_tag);
    for (int i=0; i < oldTags.length; i++) {
      allTags[i + 1]=oldTags[i];
    }
  }
  mSelectedTags.clear();
  List<String> selectedList=Arrays.asList(Utils.parseTags(mFactTags));
  int length=allTags.length;
  boolean[] checked=new boolean[length];
  for (int i=0; i < length; i++) {
    String tag=allTags[i];
    if (selectedList.contains(tag)) {
      checked[i]=true;
      mSelectedTags.add(tag);
    }
  }
  AlertDialog.Builder builder=new AlertDialog.Builder(this);
  builder.setTitle(R.string.studyoptions_limit_select_tags);
  builder.setMultiChoiceItems(allTags,checked,new DialogInterface.OnMultiChoiceClickListener(){
    public void onClick(    DialogInterface dialog,    int whichButton,    boolean isChecked){
      if (whichButton == 0) {
        dialog.dismiss();
        mNewTagEditText.setText("");
        mAddNewTag.show();
      }
 else {
        String tag=allTags[whichButton];
        if (!isChecked) {
          Log.i(AnkiDroidApp.TAG,"unchecked tag: " + tag);
          mSelectedTags.remove(tag);
        }
 else {
          Log.i(AnkiDroidApp.TAG,"checked tag: " + tag);
          mSelectedTags.add(tag);
        }
      }
    }
  }
);
  builder.setPositiveButton(res.getString(R.string.select),new OnClickListener(){
    @Override public void onClick(    DialogInterface dialog,    int which){
      String tags=mSelectedTags.toString();
      mFactTags=tags.substring(1,tags.length() - 1);
      mTags.setText(getResources().getString(R.string.CardEditorTags,mFactTags));
    }
  }
);
  builder.setNegativeButton(res.getString(R.string.cancel),null);
  mTagsDialog=builder.create();
}
